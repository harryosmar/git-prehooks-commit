#!/bin/bash

# commit-msg hook - Validates commit message format
# This hook is called with one argument: the name of the file that has the commit message

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Load configuration from .githooks-config.json
CONFIG_FILE=".githooks-config.json"

# Read config values
if [ -f "$CONFIG_FILE" ]; then
    JIRA_PROJECT=$(grep -A 15 '"commit-msg"' "$CONFIG_FILE" | grep '"jira_project"' | sed 's/.*: *"//;s/".*//')
    MIN_MESSAGE_LENGTH=$(grep -A 15 '"commit-msg"' "$CONFIG_FILE" | grep '"min_message_length"' | grep -o '[0-9]*')
    MAX_SUBJECT_LENGTH=$(grep -A 15 '"commit-msg"' "$CONFIG_FILE" | grep '"max_subject_length"' | grep -o '[0-9]*')
    REQUIRE_TYPE=$(grep -A 15 '"commit-msg"' "$CONFIG_FILE" | grep '"require_type"' | sed 's/.*: *//;s/[,"]//g;s/ //g')
    ALLOWED_TYPES=$(grep -A 15 '"commit-msg"' "$CONFIG_FILE" | grep '"allowed_types"' | sed 's/.*\[//;s/\].*//' | tr -d '"' | tr ',' '|' | sed 's/ //g')
fi

# Set defaults if config not found
[ -z "$JIRA_PROJECT" ] && JIRA_PROJECT="CDE"
[ -z "$MIN_MESSAGE_LENGTH" ] && MIN_MESSAGE_LENGTH=10
[ -z "$MAX_SUBJECT_LENGTH" ] && MAX_SUBJECT_LENGTH=72
[ -z "$REQUIRE_TYPE" ] && REQUIRE_TYPE="false"
[ -z "$ALLOWED_TYPES" ] && ALLOWED_TYPES="feat|fix|hotfix|docs|style|refactor|perf|test|chore|build|ci|revert|security"

JIRA_PATTERN="^${JIRA_PROJECT}-[0-9]{1,5}:"

echo -e "${YELLOW}üîç Validating commit message...${NC}"

# Skip validation for merge commits
if grep -q "^Merge" "$COMMIT_MSG_FILE"; then
    echo -e "${GREEN}‚úì Merge commit detected, skipping validation${NC}"
    exit 0
fi

# Skip validation for revert commits
if grep -q "^Revert" "$COMMIT_MSG_FILE"; then
    echo -e "${GREEN}‚úì Revert commit detected, skipping validation${NC}"
    exit 0
fi

# Extract the first line (subject)
SUBJECT=$(head -n1 "$COMMIT_MSG_FILE")

# Check 1: Validate Jira ticket format
if ! echo "$SUBJECT" | grep -qE "$JIRA_PATTERN"; then
    echo -e "${RED}‚úó Commit message REJECTED!${NC}"
    echo ""
    echo -e "${RED}Error: Commit message must start with Jira ticket format: ${JIRA_PROJECT}-XXXXX:${NC}"
    echo ""
    if [ "$REQUIRE_TYPE" = "true" ]; then
        echo "Expected format:"
        echo "  ${JIRA_PROJECT}-12345: type: Your commit message here"
        echo ""
        echo "Your commit message:"
        echo "  $SUBJECT"
        echo ""
        echo "Examples of valid commit messages:"
        echo "  ${JIRA_PROJECT}-123: feat: Add user authentication"
        echo "  ${JIRA_PROJECT}-456: fix: Resolve login bug"
        echo "  ${JIRA_PROJECT}-789: docs: Update API documentation"
        echo ""
        echo "Allowed types: $(echo $ALLOWED_TYPES | tr '|' ', ')"
    else
        echo "Expected format:"
        echo "  ${JIRA_PROJECT}-12345: Your commit message here"
        echo ""
        echo "Your commit message:"
        echo "  $SUBJECT"
        echo ""
        echo "Examples of valid commit messages:"
        echo "  ${JIRA_PROJECT}-123: Add user authentication feature"
        echo "  ${JIRA_PROJECT}-4567: Fix login bug on mobile devices"
        echo "  ${JIRA_PROJECT}-89: Update documentation for API endpoints"
    fi
    exit 1
fi

# Check 1b: Validate commit type (if required)
if [ "$REQUIRE_TYPE" = "true" ]; then
    # Extract message after ticket (e.g., "feat: Add feature" from "CDE-123: feat: Add feature")
    MESSAGE_AFTER_TICKET=$(echo "$SUBJECT" | sed -E "s/${JIRA_PATTERN}//" | sed 's/^[[:space:]]*//')
    
    # Check if message starts with a type
    COMMIT_TYPE=$(echo "$MESSAGE_AFTER_TICKET" | grep -oE '^[a-z]+:' | tr -d ':')
    
    if [ -z "$COMMIT_TYPE" ]; then
        echo -e "${RED}‚úó Commit message REJECTED!${NC}"
        echo ""
        echo -e "${RED}Error: Commit message must include a type${NC}"
        echo ""
        echo "Expected format:"
        echo "  ${JIRA_PROJECT}-12345: type: Your commit message"
        echo ""
        echo "Your commit message:"
        echo "  $SUBJECT"
        echo ""
        echo "Allowed types: $(echo $ALLOWED_TYPES | tr '|' ', ')"
        echo ""
        echo "Examples:"
        echo "  ${JIRA_PROJECT}-123: feat: Add user authentication"
        echo "  ${JIRA_PROJECT}-456: fix: Resolve login timeout"
        echo "  ${JIRA_PROJECT}-789: docs: Update API documentation"
        exit 1
    fi
    
    # Validate type is in allowed list
    if ! echo "$COMMIT_TYPE" | grep -qE "^($ALLOWED_TYPES)$"; then
        echo -e "${RED}‚úó Commit message REJECTED!${NC}"
        echo ""
        echo -e "${RED}Error: Invalid commit type '${COMMIT_TYPE}'${NC}"
        echo ""
        echo "Allowed types: $(echo $ALLOWED_TYPES | tr '|' ', ')"
        echo ""
        echo "Your commit message:"
        echo "  $SUBJECT"
        exit 1
    fi
fi

# Check 2: Validate minimum message length (after ticket number and type)
MESSAGE_BODY=$(echo "$SUBJECT" | sed -E "s/${JIRA_PATTERN}//")

# If type is required, remove it from message body for length check
if [ "$REQUIRE_TYPE" = "true" ] && [ -n "$COMMIT_TYPE" ]; then
    MESSAGE_BODY=$(echo "$MESSAGE_BODY" | sed -E "s/^${COMMIT_TYPE}:[[:space:]]*//")
fi

MESSAGE_LENGTH=${#MESSAGE_BODY}

if [ $MESSAGE_LENGTH -lt $MIN_MESSAGE_LENGTH ]; then
    echo -e "${RED}‚úó Commit message REJECTED!${NC}"
    echo ""
    echo -e "${RED}Error: Commit message is too short (minimum $MIN_MESSAGE_LENGTH characters after ticket number)${NC}"
    echo ""
    echo "Your message: $MESSAGE_BODY"
    echo "Length: $MESSAGE_LENGTH characters"
    exit 1
fi

# Check 3: Validate subject line length
SUBJECT_LENGTH=${#SUBJECT}
if [ $SUBJECT_LENGTH -gt $MAX_SUBJECT_LENGTH ]; then
    echo -e "${YELLOW}‚ö† Warning: Subject line is longer than $MAX_SUBJECT_LENGTH characters ($SUBJECT_LENGTH)${NC}"
    echo "Consider making it more concise or moving details to the commit body."
    echo ""
fi

# Check 4: Ensure first letter after ticket is capitalized
FIRST_CHAR=$(echo "$MESSAGE_BODY" | sed 's/^[[:space:]]*//' | cut -c1)
if ! echo "$FIRST_CHAR" | grep -q '[A-Z]'; then
    echo -e "${YELLOW}‚ö† Warning: Message should start with a capital letter${NC}"
    echo ""
fi

# Check 5: Warn if subject ends with a period
if echo "$SUBJECT" | grep -q '\.$'; then
    echo -e "${YELLOW}‚ö† Warning: Subject line should not end with a period${NC}"
    echo ""
fi

# Check 6: Validate imperative mood (common words)
FIRST_WORD=$(echo "$MESSAGE_BODY" | sed 's/^[[:space:]]*//' | awk '{print tolower($1)}')
NON_IMPERATIVE_WORDS="added|adding|fixed|fixing|updated|updating|changed|changing|removed|removing"

if echo "$FIRST_WORD" | grep -qE "^($NON_IMPERATIVE_WORDS)"; then
    echo -e "${YELLOW}‚ö† Warning: Use imperative mood (e.g., 'Add' not 'Added', 'Fix' not 'Fixed')${NC}"
    echo ""
fi

# Success message
echo -e "${GREEN}‚úì Commit message validated successfully!${NC}"
echo ""
echo "Ticket: $(echo "$SUBJECT" | grep -oE "${JIRA_PROJECT}-[0-9]+")"
echo "Message: $MESSAGE_BODY"

exit 0
